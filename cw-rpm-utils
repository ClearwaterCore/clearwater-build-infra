#!/bin/bash
# Note that this script is only ever expected to be source-d into another
# script - the !/bin/bash comment above is just so that vim can do
# syntax-highlighting correctly.

export CW_RPM_UTILS_PACKAGE=$1
export CW_RPM_UTILS_TOPDIR=$2
export CW_RPM_UTILS_BUILDROOT=$3

function setup_buildroot {
  rm -rf ${CW_RPM_UTILS_BUILDROOT}
  copy_to_buildroot build-infra/LICENSE /usr/share/licenses/$CW_RPM_UTILS_PACKAGE
}

function copy_to_buildroot {
  mkdir -p ${CW_RPM_UTILS_BUILDROOT}$2
  cp -rp ${CW_RPM_UTILS_TOPDIR}/$1 ${CW_RPM_UTILS_BUILDROOT}/$2/$3
}

function install_to_buildroot {
  export -f copy_to_buildroot
  xargs -r -I {} bash -c 'copy_to_buildroot "$(cut -d\  -f 1 <<< "{}")" "$(cut -d\  -f 2 <<< "{}")"'
}

function dirs_to_buildroot {
  xargs -r -I {} mkdir -p ${CW_RPM_UTILS_BUILDROOT}/{}
}

function build_files_list {
  cd ${CW_RPM_UTILS_BUILDROOT}
  find . -type f -a -executable |
  sed -e 's/^\./%attr(755, -, -) /g' |
  sed -e 's/ \(\/etc\/\)/ %config \1/g'
  find . -type f -a ! -executable -o -type d -empty |
  sed -e 's/^\.//g' |
  sed -e 's/^\(\/etc\/\)/%config \1/g' |
  sed -e 's/ \(\/etc\/init.d\/\)/ %attr(755, -, -) \1/g' |
  sed -e 's/^\(\/usr\/share\/licenses\/[^/]*\/LICENSE\)/%doc \1/g'
  cd - > /dev/null
}
